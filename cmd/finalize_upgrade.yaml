description: |
    This action will run the CEDR to DRS finalize-upgrade action. This is meant to run on all nodes that will be upgraded to DRS.
schemaVersion: '2.2'
parameters:
    apiToken:
        type: String
        description: (Required) CloudEndure API token.
    projectId:
        type: String
        description: (Required) UUID of the CloudEndure Project to upgrade.
    awsAccessKey:
        type: String
        description: (Required) AWS access key from target DRS account IAM user.
    awsSecretAccessKey:
        type: String
        description: (Required) AWS secret access key from target DRS account IAM user.
mainSteps:
    - action: aws:downloadContent
      name: downloadUpgradeLinux
      precondition:
        StringEquals:
            - platformType
            - Linux
      inputs:
        sourceType: "S3"
        sourceInfo: '{"path": "https://cloudendure-assets.s3.us-east-1.amazonaws.com/latest/cloudendure_to_drs_upgrade_tool.py"}'
    - action: aws:runShellScript
      name: RunFinalizeUpgradeToolLinux
      precondition:
        StringEquals:
            - platformType
            - Linux
      inputs:
        timeoutSeconds: '3600'
        runCommand:
            - "python3 cloudendure_to_drs_upgrade_tool.py finalize-upgrade --api-token {{ apiToken }}  --project-id {{ projectId }} --aws-access-key-id {{ awsAccessKey }} --aws-secret-access-key {{ awsSecretAccessKey }}"
    - action: aws:downloadContent
      name: downloadUpgradeWindows
      precondition:
        StringEquals:
            - platformType
            - Windows
      inputs:
        sourceType: "S3"
        sourceInfo: '{"path": "https://cloudendure-assets.s3.us-east-1.amazonaws.com/latest/cloudendure_to_drs_upgrade_tool.exe"}'
        destinationPath: "C:\\temp\\"
    - action: aws:runPowerShellScript
      name: RunFinalizeUpgradeToolWindows
      precondition:
        StringEquals:
            - platformType
            - Windows
      inputs:
        timeoutSeconds: '3600'
        runCommand:
            - |
               $Install = Start-Process -NoNewWindow -PassThru -Wait -FilePath "C:\temp\cloudendure_to_drs_upgrade_tool.exe" -ArgumentList "finalize-upgrade --api-token {{ apiToken }}  --project-id {{ projectId }} --aws-access-key-id {{ awsAccessKey }} --aws-secret-access-key {{ awsSecretAccessKey }} --import-test-snapshot --import-blueprint"
               If ($Install.ExitCode -ne 0) {
                    Write-Output "Error Upgrading to DRS exit code $($Process.ExitCode)"
                    Exit 1
                }
